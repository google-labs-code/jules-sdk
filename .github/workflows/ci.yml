# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Prevents multiple runs on the same PR from overlapping
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to see commit history and changed files

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.3.1"

      # Bun install is fast enough that complex caching of node_modules often adds more overhead than it saves.
      # We'll rely on Bun's speed. If needed, we can cache ~/.bun/install/cache.

      - name: Install dependencies
        run: bun install

      # Quality Checks
      - name: Check Formatting (warning only)
        id: format
        continue-on-error: true
        run: |
          bun run format:check || echo "::warning::Formatting issues detected. Run 'bun run format' locally."

      - name: Type Check
        id: types
        continue-on-error: true
        run: bun run typecheck

      - name: Run Tests
        id: tests
        continue-on-error: true
        run: bun run test

      - name: Production Build
        id: build
        continue-on-error: true
        run: bun run build

      - name: Smoke Test
        id: smoke
        continue-on-error: true
        run: bun run test:smoke

      - name: Fail Job if Errors
        if: always()
        run: |
          if [ "${{ steps.types.outcome }}" = "failure" ] || \
             [ "${{ steps.tests.outcome }}" = "failure" ] || \
             [ "${{ steps.build.outcome }}" = "failure" ] || \
             [ "${{ steps.smoke.outcome }}" = "failure" ]; then
            echo "One or more checks failed."
            exit 1
          fi
